@startuml SD_35_Hapus_Riwayat_Pelanggaran
' ============================================================================
' SEQUENCE DIAGRAM - HAPUS RIWAYAT PELANGGARAN
' ============================================================================
' Use Case: Kelola Riwayat Pelanggaran
' Aktor:
'   - Operator: bisa hapus SEMUA tanpa batasan waktu
'   - Guru/Wali Kelas/Kaprodi/Waka: hanya milik sendiri, max 3 hari
' ============================================================================

skinparam backgroundColor #FEFEFE
skinparam shadowing false
skinparam defaultFontName "Segoe UI"
skinparam defaultFontSize 10

skinparam sequence {
    ArrowColor #455A64
    ArrowFontColor #37474F
    LifeLineBorderColor #78909C
    LifeLineBackgroundColor #ECEFF1
    ParticipantBorderColor #37474F
    ParticipantBackgroundColor #FFFFFF
    ActorBorderColor #1976D2
    ActorBackgroundColor #E3F2FD
    BoxBorderColor #9E9E9E
    BoxBackgroundColor #FAFAFA
}

autonumber

title **SD-35: Hapus Riwayat Pelanggaran**

actor "Operator / Guru /\nWali Kelas / Kaprodi /\nWaka" as USER

box "Application Layer" #E8F5E9
    participant "PelanggaranController" as PC
    participant "RiwayatPelanggaran\nPolicy" as PP
end box

box "Data Layer" #FFF3E0
    participant "RiwayatPelanggaran" as RP
    participant "TindakLanjut" as TL
    database "MySQL" as DB
end box

== Proses Hapus ==

USER -> PC : DELETE /pelanggaran/id
activate PC

PC -> RP : findOrFail(id)
activate RP
RP -> DB : SELECT * FROM riwayat_pelanggaran WHERE id = ?
DB --> RP : Riwayat data
RP --> PC : Riwayat object
deactivate RP

PC -> PP : authorize(delete, riwayat)
activate PP

alt Role = Operator Sekolah
    PP --> PC : Allowed\n(bisa hapus SEMUA tanpa batasan)
else Role lain (Guru/Wali Kelas/Kaprodi/Waka)
    PP -> PP : Check ownership\n(riwayat.guru_pencatat_user_id == auth.id)
    
    alt Bukan pemilik
        PP --> PC : Forbidden (403)
        PC --> USER : Error: "Anda hanya bisa hapus\npelanggaran yang Anda catat"
    else Adalah pemilik
        PP -> PP : Check time limit\n(created_at + 3 HARI > now)
        
        alt Lebih dari 3 hari
            PP --> PC : Forbidden (403)
            PC --> USER : Error: "Sudah lewat batas waktu hapus (3 hari)"
        else Masih dalam 3 hari
            PP --> PC : Allowed
        end
    end
end
deactivate PP

PC -> TL : where riwayat_pelanggaran_id = id\n->exists()
activate TL
TL -> DB : SELECT EXISTS FROM tindak_lanjut\nWHERE riwayat_pelanggaran_id = ?
DB --> TL : exists boolean
TL --> PC : exists?
deactivate TL

alt Ada tindak lanjut terkait
    PC --> USER : Error: "Tidak bisa hapus,\nada tindak lanjut terkait"
else Tidak ada tindak lanjut
    PC -> RP : delete()
    activate RP
    RP -> DB : UPDATE riwayat_pelanggaran\nSET deleted_at = NOW()
    DB --> RP : Soft deleted
    RP --> PC : Success
    deactivate RP
    
    PC --> USER : Redirect /pelanggaran/riwayat\nFlash: "Riwayat pelanggaran berhasil dihapus"
end
deactivate PC

@enduml
