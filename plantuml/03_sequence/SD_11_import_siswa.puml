@startuml SD_11_Import_Siswa
' ============================================================================
' SEQUENCE DIAGRAM - IMPORT SISWA (BULK)
' ============================================================================
' Use Case: Kelola Siswa
' Aktor: Operator Sekolah
' Deskripsi: Import data siswa secara bulk dari file CSV
' ============================================================================

skinparam backgroundColor #FEFEFE
skinparam shadowing false
skinparam defaultFontName "Segoe UI"
skinparam defaultFontSize 10

skinparam sequence {
    ArrowColor #455A64
    ArrowFontColor #37474F
    LifeLineBorderColor #78909C
    LifeLineBackgroundColor #ECEFF1
    ParticipantBorderColor #37474F
    ParticipantBackgroundColor #FFFFFF
    ActorBorderColor #1976D2
    ActorBackgroundColor #E3F2FD
    BoxBorderColor #9E9E9E
    BoxBackgroundColor #FAFAFA
}

autonumber

title **SD-11: Import Siswa (Bulk)**

actor "Operator\nSekolah" as OPERATOR

box "Application Layer" #E8F5E9
    participant "SiswaController" as SC
    participant "SiswaService" as SS
end box

box "Data Layer" #FFF3E0
    participant "Siswa Model" as SM
    participant "User Model" as UM
    participant "Kelas Model" as KM
    database "MySQL" as DB
end box

== Tampilkan Form Import ==

OPERATOR -> SC : GET /siswa/bulk-create
activate SC

SC -> KM : all()
activate KM
KM -> DB : SELECT * FROM kelas
DB --> KM : Kelas data
KM --> SC : Daftar Kelas
deactivate KM

SC --> OPERATOR : Form bulk import:\n- Pilih Kelas\n- Upload CSV atau Input Manual\n- Checkbox: Buat akun wali untuk semua
deactivate SC

== Upload dan Proses CSV ==

OPERATOR -> SC : POST /siswa/bulk-store\n(kelas_id, bulk_file.csv, create_wali_all)
activate SC

SC -> SC : validate(kelas_id, bulk_file)

SC -> SC : parseCSV(file)

loop Untuk setiap baris
    SC -> SC : Validate NISN (10 digit)
    SC -> SM : Check NISN exists in DB
    activate SM
    SM -> DB : SELECT id FROM siswa\nWHERE nisn = ?
    DB --> SM : exists?
    SM --> SC : Boolean
    deactivate SM
    
    alt NISN sudah ada
        SC -> SC : Add to errors array
    else NISN valid
        SC -> SC : Add to validRows array
    end
end

alt Tidak ada row valid
    SC --> OPERATOR : Error: "Tidak ada data valid"
else Ada row valid
    SC -> SS : bulkCreateSiswa(validRows, kelasId, createWaliAll)
    activate SS
    
    loop Untuk setiap validRow
        SS -> SM : create(data)
        activate SM
        SM -> DB : INSERT INTO siswa
        DB --> SM : Created
        SM --> SS : Siswa object
        deactivate SM
        
        alt create_wali_all = true
            SS -> UM : create wali user
            activate UM
            UM -> DB : INSERT INTO users
            DB --> UM : Created
            UM --> SS : User object
            deactivate UM
            
            SS -> SM : update wali_murid_id
            activate SM
            SM -> DB : UPDATE siswa SET wali_murid_id = ?
            DB --> SM : Updated
            SM --> SS : Success
            deactivate SM
        end
    end
    
    SS --> SC : Return {success_count, wali_credentials}
    deactivate SS
    
    SC --> OPERATOR : Redirect /siswa\nFlash: "Berhasil import X siswa"\n+ Tampilkan kredensial wali
end
deactivate SC

@enduml
